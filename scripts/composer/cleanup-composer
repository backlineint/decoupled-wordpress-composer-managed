#!/bin/bash

# Exit immediately on errors, and echo commands as they are executed.
set -e

function copy_files() {
  # Copy the mu-plugins loader file.
  if [ ! -f "web/wp-content/mu-plugins/loader.php" ]; then
    echo "ðŸ“‚ ðŸ’¨  Copying the mu-plugins loader file..."
    cp -v vendor/pantheon-systems/pantheon-wp-loader/loader.php web/wp-content/mu-plugins/
    echo "âœ… Done!"
  fi

  # Copy the Pantheon upstream config file.
  if [ ! -f "web/wp/pantheon.upstream.yml" ]; then
    echo "ðŸ“‚ ðŸ’¨  Copying the Pantheon upstream config file..."
    cp -v vendor/pantheon-systems/wordpress-integrations/pantheon.upstream.yml web/wp/
    echo "âœ… Done!"
  fi

  # Copy over the mu-plugins folder from core wp, if it exists.
  if [ -d "web/wp/wp-content/mu-plugins/" ]; then
    echo "ðŸ“‚ ðŸ’¨  Copying mu-plugins..."
    rsync -rvv ./web/wp/wp-content/mu-plugins/* web/wp-content/mu-plugins/
    echo "âœ… Done!"
  fi

  if [ ! -f "web/wp-config.php" ]; then
    echo "ðŸ“‚ ðŸ’¨  Copying wp-config.php..."
    cp -v vendor/pantheon-systems/pantheon-wp-config/wp-config.php web/
    echo "âœ… Done!"
  fi

  if [ ! -f "web/index.php" ]; then
    echo "ðŸ“‚ ðŸ’¨  Copying default index file..."
    cp -v vendor/pantheon-systems/wordpress-integrations/index.php web/
    echo "âœ… Done!"
  fi

  if [ ! -f "web/wp-cli.yml" ]; then
    echo "ðŸ“‚ ðŸ’¨  Copying WP-CLI configuration file..."
    cp -v vendor/pantheon-systems/wordpress-integrations/wp-cli.yml web/
    echo "âœ… Done!"
  fi

  copy_bedrock_muplugins
}

function copy_bedrock_muplugins() {
  echo "ðŸ“‚ ðŸ’¨  Copying Bedrock mu-plugins 1/3..."
  if [ ! -f "web/wp-content/mu-plugins/bedrock-autoloader.php" ]; then
    cp -v vendor/roots/bedrock/web/app/mu-plugins/bedrock-autoloader.php web/wp-content/mu-plugins/
  fi

  echo "ðŸ“‚ ðŸ’¨  Copying Bedrock mu-plugins 2/3..."
  if [ ! -f "web/wp-content/mu-plugins/disallow-indexing.php" ]; then
    cp -v vendor/roots/bedrock/web/app/mu-plugins/disallow-indexing.php web/wp-content/mu-plugins/
  fi

  echo "ðŸ“‚ ðŸ’¨  Copying Bedrock mu-plugins 3/3..."
  if [ ! -f "web/wp-content/mu-plugins/register-theme-directory.php" ]; then
    cp -v vendor/roots/bedrock/web/app/mu-plugins/register-theme-directory.php web/wp-content/mu-plugins/
  fi

  echo "âœ… Done!"
}

function remove_files() {
  # Delete the core wp-config file, if it exists.
  if [ -f "web/wp/wp-config.php" ]; then
    echo "ðŸ—‘ ðŸ’¥ Removing unused wp-config.php file from Bedrock install..."
    rm -v ./web/wp/wp-config.php
    echo "âœ… Done!"
  fi

  # Remove the wp-content directory from core WordPress.
  if [ -d "web/wp/wp-content" ]; then
    echo "ðŸ—‘ ðŸ’¥ Removing unused wp-content directory from Bedrock install..."
    rm -rfv ./web/wp/wp-content
    echo "âœ… Done!"
  fi
}

copy_files
remove_files